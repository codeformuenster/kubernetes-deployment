apiVersion: batch/v1
kind: Job
metadata:
  name: initial-import
  labels:
    app.kubernetes.io/name: initial-import
    app.kubernetes.io/component: initial-import
spec:
  parallelism: 1
  template:
    spec:
      restartPolicy: OnFailure
      volumes:
      - name: dotenv
        configMap:
          name: meine-stadt-transparent-dot-env
      containers:
      - name: import-scraped-json
        image: konstin2/meine-stadt-transparent:v0.2.9
        imagePullPolicy: Always
        command:
        - /bin/bash
        - -c
        args:
        - 'set -e &&
          echo "Initial Import of $OPARL_BODY" &&
          /app/.venv/bin/python /app/manage.py setup &&
          /app/.venv/bin/python /app/manage.py import_body --manual "$OPARL_BODY" &&
          /app/.venv/bin/python /app/manage.py import_streets 1 --ags "$AGS" &&
          /app/.venv/bin/python /app/manage.py import_amenities school 1 --ags "$AGS" &&
          /app/.venv/bin/python /app/manage.py import_outline 1 --ags "$AGS" &&
          /app/.venv/bin/python /app/manage.py import_fetch &&
          /app/.venv/bin/python /app/manage.py import_objects &&
          /app/.venv/bin/python /app/manage.py import_files'
        volumeMounts:
        - name: dotenv
          mountPath: /app/.env
          subPath: .env
        env:
        - name: OPARL_BODY
          valueFrom:
            configMapKeyRef:
              name: deployment-properties
              key: OPARL_BODY
        - name: AGS
          valueFrom:
            configMapKeyRef:
              name: deployment-properties
              key: AGS
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: meine-stadt-transparent-secrets
              key: database_url
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: meine-stadt-transparent-secrets
              key: sentry_dsn
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: meine-stadt-transparent-secrets
              key: secret_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio
              key: secret-key
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio
              key: access-key
        - name: EMAIL_URL
          valueFrom:
            secretKeyRef:
              name: meine-stadt-transparent-secrets
              key: email_url
